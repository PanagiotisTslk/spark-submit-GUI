# Fetch ubuntu from Dockerhub
FROM ubuntu:22.04
LABEL authors="panagiotis_tsolkas"

# Environment Variables
ENV SPARK_VERSION=3.0.2
ENV HADOOP_VERSION=3.2
ENV SPARK_HOME=/KubernetesAPI/executor/opt/spark
ENV PYTHONHASHSEED=1
ENV CERTIFICATE_AUTHORITY_DATA=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUREekNDQWZlZ0F3SUJBZ0lVWmpUMzRzeGNUMVUwTzI1dWFRcnpBb1ZEalJrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0Z6RVZNQk1HQTFVRUF3d01NVEF1TVRVeUxqRTRNeTR4TUI0WERUSTBNRFl3T0RFM01qWXlNVm9YRFRNMApNRFl3TmpFM01qWXlNVm93RnpFVk1CTUdBMVVFQXd3TU1UQXVNVFV5TGpFNE15NHhNSUlCSWpBTkJna3Foa2lHCjl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF2bGFwalo1ZEVTR1FzL21HbFpXWGZUNmtmc0x6WnR1L0NDNGUKa3NoYmJzenFFWGg3cjRYSHpYWkFUdjh5Nzh4OXJOZHJXaFRERDFRbC9sQndiRktncGJ4NWVNMWd3QzRzaXFoVwpvbFFJbkN1d01SaWUrMHhad2xiS0g0ajNiWjZUeEVMOTM1MkhPVXQvUlpaY1Zkb0c0YmtaWEdLNlJRRkVmK05lCkU5UWE2MzNocm9TM0trc1JsRDlSQkJ6WUZxSG9QcHk1dEtDbnM5L1lCbXpjL0xmS3I4UHhmQlp3T08zMGRIOGIKT1picFU3cTJ4YU4zY0N3THJxaVNQTTVZTTRiY2VCTDlieHpLS3luenlHdGo1ZUhoV3lJb0JLdEhqcnBOYXlnLwo4TTJDN3BwSlVwcFZqOUlUY3ZSR3lpUWszN0pTMjlqdHYwbVR4c3dGNWpNemxWc2w4UUlEQVFBQm8xTXdVVEFkCkJnTlZIUTRFRmdRVW1FSzhuelFKTzhua1VPS1pXb21uVy9WanZRQXdId1lEVlIwakJCZ3dGb0FVbUVLOG56UUoKTzhua1VPS1pXb21uVy9WanZRQXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQwpBUUVBTWxsL0RuWEord0FrVnRHTUw5bFhMQVVKbndjdk1YR3YwdkdTRXpxaUhxNVUxZlpyUUJjOGtFdmZHdDFUCmE1blZjT3dnSnhrYzNDd0loS2VrVExSQ2xTem4xZEY5c1FveVZJWVlJak9WSGJYT2NEVWR4V0k2enZ0aDN6YmQKRmFzdDVHaUQySG1ic3pDUnZ5RDl0L0xWU3hKbGNTa0pFZnRTTUh6cVlQSnFKMUtkb3g4dExZVEVIQlJSdHFxVwpQZzZldnovVXlZTU9wMmpmWnFPRnVMN3B4bUlESG1YS1hianVWSjZRSFdjcFJCU3k4Sk9heXRrV2ZDS2ZXUGtHCnV6ZzE5OVUzSkpXU3Z6UXFwVTFMK29kMkdubS8wbHBseDlEbWJhVDFBNnFvM1B2U2hCa1Q5WHhKUzdhYnJqdVEKOFhFNmR1blRyNzYrb3BPTGtQUnYyU0NRT3c9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
ENV CLIENT_CERTIFICATE_DATA=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN6RENDQWJTZ0F3SUJBZ0lVZWwreHRtK0t1L3V4WG9IaC9TbllCYkFDdHZrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0Z6RVZNQk1HQTFVRUF3d01NVEF1TVRVeUxqRTRNeTR4TUI0WERUSTBNRFl3T0RFM01qWXlNVm9YRFRNMApNRFl3TmpFM01qWXlNVm93S1RFT01Bd0dBMVVFQXd3RllXUnRhVzR4RnpBVkJnTlZCQW9NRG5ONWMzUmxiVHB0CllYTjBaWEp6TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUFuM20wbnZUbnc5Q1IKUWtoVFB5akludGcxWU1SVTIrSC80dGpGdm45NitUZDhmRE5Gb1VDelJtWHAzVUptc0kyeFdOVlNyQVFVc3gwcApLRk1LRi8rdFUxWW5wWk1tVUtrQ3M0aUZ5bUJvM0hHMlhIU0dHMUVqc01SM1BiSy8veGljd0lEdjJUaDVrSTMrCmRiR0RPazJPYWFpVEhkbnNqcVhMTHk0ajdGWWpFaS9UYTF4VFBQTGlORjYwRk1FdC9HdlRQUVJicnFzck1ibncKcHNJQVlJd1FiZ1N0WkdXOG1NVEFmeEpqVXJTZnlrMVF6TGRIQXQvL2p1ZC94S09JdWFoMGp5QURuU0diYnFZdQpUN0R3eU56WmNtK3ErYUczazhlZ3RkcWVXc3NYRGRZaHVQc0UvcjZybDZMVXlSSFRIQkU2Zm9qN0szQlBXSTlvCk43NUd0dW5pTndJREFRQUJNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUJQYUc2NGtBTWN0Z2hSZFZrUVdvKy8KMmpVZ0xUTlQyVFN1RG5sM2FYdDB0SUhBNG96U0d6ZzhPZjRHbzMzY1htMHJLaTMvOG0vTEpSRmpCeFhtZUU4agprN3B0RzROMExpQnkrYlpXOHpYbWNnVXdEWm1RU1lRV1E2eDduZkxOcSt3QjlGK3pJV3VjMk1raGI3SEIvZkRVCkh3NjNxanBNdHNoTks0WWF1czBXV1NVM0JTbGRZS05LelJQYnhqL01Yang3bG5vbmtiMCtjY21UUmcrdUF0NzQKaks2T3A1cGVpVEQ2c0xFZnJhYm5VY3diNGVnYWh5V1lnaG1rWGptQWpBZnFMMDRsUmNrOUdnMjl3NjJHZnpoYgpUNEVWTmduQksyVmhUN25wZVFJTTZTcVI2c1pPa3BaUGFtV0VHVnpJNjRGODh4SDNaVGw5UFlUZWZ6TUI3d1UzCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
ENV CLIENT_KEY_DATA='LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcGdJQkFBS0NBUUVBbjNtMG52VG53OUNSUWtoVFB5akludGcxWU1SVTIrSC80dGpGdm45NitUZDhmRE5GCm9VQ3pSbVhwM1VKbXNJMnhXTlZTckFRVXN4MHBLRk1LRi8rdFUxWW5wWk1tVUtrQ3M0aUZ5bUJvM0hHMlhIU0cKRzFFanNNUjNQYksvL3hpY3dJRHYyVGg1a0kzK2RiR0RPazJPYWFpVEhkbnNqcVhMTHk0ajdGWWpFaS9UYTF4VApQUExpTkY2MEZNRXQvR3ZUUFFSYnJxc3JNYm53cHNJQVlJd1FiZ1N0WkdXOG1NVEFmeEpqVXJTZnlrMVF6TGRICkF0Ly9qdWQveEtPSXVhaDBqeUFEblNHYmJxWXVUN0R3eU56WmNtK3ErYUczazhlZ3RkcWVXc3NYRGRZaHVQc0UKL3I2cmw2TFV5UkhUSEJFNmZvajdLM0JQV0k5b043NUd0dW5pTndJREFRQUJBb0lCQVFDVHNDMkN6RUhiQ1V1TQorOWdFZE91ZWw1S1BaQ05HWXYwTUF6N1dWYzczLzlmTVdkdFJJODhqRWZ6TUNOTjdEQzNDbkFSdEEzWjhEalJ3CmdMNm5UUVFpV25ackUyUjNiSjN3MEMwL0o1dlZFNFlVQjJHdTZLeko1cGliVGZBYStac3BkLzhueHZKbDJlcGUKNnA4aUhuTVdES1Q2RHpqUlBsOTErU0FSbmcvcXBXTzJCeXo2R1ZxaThPcXJjMGtGV1o3VlVnY3drajNUaDdXSgpKNEk1aFBodFhqT0czRElPV2RUNG5DSkFKUzJtWHB0bGJrOGpjVm1XVUVzK0EwOWlySDhMTVlLbGJmMWJqb0ZLCkhKdHRHZUxLYnNFVGV6N1B3YjZKNS80cFBENmp5cWZ3cHRaSDJnL21tZE9XbENMTGhYdTA5OXRMZG1jM1BKNjUKWWxLQ2JlcEJBb0dCQU0xZkNzUmxBOEdyTDUxQ1dlbVU5YXh2OEdaQjAwS3VMbUlEeWoxMTN4ZUhXSWRHZ2p0Vwo1YVlqN0tCenoxZnp6UnBHQVo3L0NvRUQ1bU5xSWd6eUZmcER0NmhQRnAwWXdSM2VpMy85dnN3TFZZNjZiSkJhCjJPaHlMSnhhaWhwcWZCdnVkQWZaWjRkSWlXYzEzTndpUTNTeGZsdDFGL09sMElpWXQwK3pYVU1YQW9HQkFNYksKTG42QWd2QVVMZzZ4UGZlZlJEb21LV0VuUGI2bjUrUmJ5aXdWTE1hL2kwcWdoemR1dFhIejJvd2R4bWJoTTJBbgpLblVWazZvbVNlU3lSMnY0aEl3SlhGUG5FVVZNMnpZMDl3bGpMV2Y1TW1IckFmQUk1RlY5YXIrRVJ6YU01ZlJICjkwRUxJeFcrN2xRR2Myd3RXODZTaHhsQ2REeHBOdnZvSU5lcjNFM2hBb0dCQUliSjJ5STgvak1zN0dvMU14ZlkKT1VtOGlqWkMrNm5tOGZCSWRvTFNDdUxCWlB3YjdidU9jOWtQK096eU5XS1BVOHpycDRLMzl5Zm43RnpST3BudQpoVGdsRzdQdWZIUU0zQ3FEZG1GQm8rajlnMkRTd0JBYVlBUm5jeG9IWGw2cUJ0eTZLeE0vdi9BTlRva2IwK0h5CjV2eit4V1MzUEVvZ1NQWnQ3Tm4xYWI5dkFvR0JBSjNXZ3J3bXhkQmg5WC9zODByZHhvcDFLbjNkYm9VblJGUnAKSFVtTE5wWklHQTBWRU1mT3UzclRLRUFBbER1enE5czR2ZGxoWEhISkhQcmRJeUJ6bnFxaDlCRWFjdmdYWWliVQpQeUhSQVlpQXNLUld1SjhpTUVwQTNyVmFEa0VkOXFmVFRGcjB3TkxQV3VTVWlxam1Ddk1tSE9iTmdRVkdkVVhtCnRjMEl4RStCQW9HQkFMaE1nRlJ5b2pJSkdPNWZIZTFNUmxEWW1hbWg2d2ZDclVwNXMvVE50bGwwYlJWTW0rQzcKNWVJeGNBQzUzRWh2T2RJZ1RHcks4Y3hTU0pTb256dS9JSjY0c3ZjSUg2YkVuRzJsSWlwYWxoYjU2OW1Deks0MwprUGIrelExeFNHRmtpN21CcDRSM0NnVWt3Uk1YZTBNZDVWb0JDUjF4cXFRd2FYL2Nua1RJcXZ4ZwotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo='
ENV SERVER=https://192.168.0.201:16443

# Set working directory
WORKDIR /KubernetesAPI/executor

# Install Java and Python
RUN apt-get update && \
  apt-get upgrade -y && \
  apt-get install -q -y openjdk-8-jdk python3-pip libsnappy-dev language-pack-en supervisor

#RUN pip3 install --upgrade pip requests

# Install wget
RUN  apt-get update \
  && apt-get install -y wget \
  && rm -rf /var/lib/apt/lists/*

# Download and uncompress spark from the apache archive
RUN wget --no-verbose -O apache-spark.tgz "https://archive.apache.org/dist/spark/spark-${SPARK_VERSION}/spark-${SPARK_VERSION}-bin-hadoop${HADOOP_VERSION}.tgz" \
&& mkdir -p /KubernetesAPI/executor/opt/spark \
&& tar -xf apache-spark.tgz -C /KubernetesAPI/executor/opt/spark --strip-components=1 \
&& rm apache-spark.tgz

#CMD ["/bin/bash"]

# Install curl
RUN  apt-get update \
  && apt-get install -y curl

# Install sudo
RUN apt install sudo

# Download and install kubectl
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"
RUN echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check
RUN sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
RUN kubectl version --client

## Downloading and installing Minikube
#RUN curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
#RUN install minikube-linux-amd64 /usr/local/bin/minikube && rm minikube-linux-amd64

# Copy all files from directory, install python's requirements and run executor
COPY ./* .
RUN python3 -m pip install -r requirements2.txt

# Initialize config by setting up a cluster
RUN kubectl config set-cluster KubernetesAPI

# Create configuration for kubectl
RUN ./kubectl_config.sh

CMD ["python3", "JobExecutor.py"]
